<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Karakunku Farm — Pest & Soil Quick Check</title>
  <style>
    :root { --accent: #2a6a32; --card: #ffffff; --bg: #f4f8f4; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:16px; background:var(--bg); color:#0b2b16; }
    header { text-align:center; margin-bottom:12px; }
    h1 { margin:6px 0; font-size:1.25rem; color:var(--accent); }
    p.lead { margin:0 0 12px 0; color:#144b2b; font-size:.95rem; }
    .controls { text-align:center; margin-bottom:12px; }
    input[type="file"] { display:inline-block; padding:10px; }
    button { background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.5; cursor:default; }
    .card { background:var(--card); padding:12px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.06); max-width:720px; margin:12px auto; text-align:center; }
    img#preview { max-width:100%; height:auto; border-radius:8px; display:block; margin:0 auto 8px auto; }
    #result { text-align:left; padding:10px; border-radius:8px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .small { font-size:.9rem; color:#334; }
    footer { text-align:center; margin-top:12px; color:#234; font-size:.85rem; }
    @media (min-width:600px) { .controls { display:flex; gap:10px; justify-content:center; align-items:center; } }
  </style>
</head>
<body>
  <header>
    <h1>Karakunku Farm — Quick Plant & Soil Check</h1>
    <p class="lead">Snap or upload a photo of your plant or soil. This tool performs a fast, offline image analysis (heuristic) and gives suggestions. Not a lab test — use results as guidance.</p>
  </header>

  <main class="card" role="main" aria-live="polite">
    <div class="controls">
      <input id="file" type="file" accept="image/*" capture="environment" aria-label="Take or choose a photo" />
      <div class="row">
        <button id="analyzeBtn" disabled>Analyze Image</button>
        <button id="clearBtn" type="button">Clear</button>
      </div>
    </div>

    <div id="previewContainer" style="display:none;">
      <img id="preview" alt="Selected photo preview" />
    </div>

    <div id="result" style="display:none;">
      <!-- Results will be injected here -->
    </div>

    <!-- Hidden canvas used for image pixel analysis -->
    <canvas id="workCanvas" style="display:none;"></canvas>
  </main>

  <footer>
    <div class="small">Works offline in the browser — no data leaves your device. For better accuracy, collect many images and use a trained model later.</div>
  </footer>

  <script>
  (function () {
    const fileInput = document.getElementById('file');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('previewContainer');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultDiv = document.getElementById('result');
    const canvas = document.getElementById('workCanvas');
    const ctx = canvas.getContext('2d');

    let currentObjectUrl = null;

    function reset() {
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = null;
      }
      fileInput.value = '';
      preview.src = '';
      previewContainer.style.display = 'none';
      analyzeBtn.disabled = true;
      resultDiv.style.display = 'none';
      resultDiv.innerHTML = '';
    }

    // Safety: guard image read with try/catch and timeouts to avoid UI freeze
    fileInput.addEventListener('change', (e) => {
      try {
        const file = e.target.files && e.target.files[0];
        if (!file) { reset(); return; }
        // revoke previous
        if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = URL.createObjectURL(file);
        preview.onload = () => {
          previewContainer.style.display = 'block';
          analyzeBtn.disabled = false;
        };
        preview.onerror = () => {
          alert('Cannot load that image. Try again.');
          reset();
        };
        preview.src = currentObjectUrl;
        resultDiv.style.display = 'none';
        resultDiv.innerHTML = '';
      } catch (err) {
        console.error('File read error', err);
        alert('Error loading image. Use another photo.');
        reset();
      }
    });

    clearBtn.addEventListener('click', reset);

    // Main analysis routine — synchronous but small work to avoid blocking
    async function analyzeImage() {
      try {
        analyzeBtn.disabled = true;
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<p>Analyzing image…</p>';

        // Ensure image is loaded
        if (!preview.src) {
          resultDiv.innerHTML = '<p style="color:red">No image to analyze.</p>';
          analyzeBtn.disabled = false;
          return;
        }

        // Set canvas size to scaled-down version for performance (max 600px)
        const MAX_DIM = 600;
        const imgW = preview.naturalWidth;
        const imgH = preview.naturalHeight;
        let w = imgW, h = imgH;
        if (Math.max(w, h) > MAX_DIM) {
          const ratio = MAX_DIM / Math.max(w, h);
          w = Math.round(w * ratio);
          h = Math.round(h * ratio);
        }
        canvas.width = w;
        canvas.height = h;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(preview, 0, 0, w, h);

        // Get image data
        const imgData = ctx.getImageData(0, 0, w, h);
        const data = imgData.data;
        const totalPixels = w * h;

        // Compute global averages and some spot detection counts
        let sumR = 0, sumG = 0, sumB = 0;
        let greenishCount = 0;
        let brownSpotCount = 0;
        let darkCount = 0;
        // We'll check center patch for soil vs plant content too
        const cx = Math.floor(w/2), cy = Math.floor(h/2);
        const patchSz = Math.max(8, Math.floor(Math.min(w,h)/8));

        // iterate over pixels (sample every 2nd pixel for speed)
        for (let i=0, p=0; i < data.length; i += 8, p += 2) { // step by 8 bytes =~ every 2nd pixel
          const r = data[i], g = data[i+1], b = data[i+2];
          sumR += r; sumG += g; sumB += b;
          // greenish heuristic
          if (g > r + 10 && g > b + 10 && g > 50) greenishCount++;
          // brown/damaged spot heuristic: red high, green low, not bright green
          if (r > 120 && g < 100 && r > g + 25 && r > b + 10) brownSpotCount++;
          // dark pixel
          if ((r+g+b)/3 < 60) darkCount++;
        }

        const avgR = sumR / (data.length/4);
        const avgG = sumG / (data.length/4);
        const avgB = sumB / (data.length/4);
        const greenRatio = greenishCount / (totalPixels/2); // because sampling 2x
        const brownRatio = brownSpotCount / (totalPixels/2);
        const darkRatio = darkCount / (totalPixels/2);

        // Center patch analysis
        const patch = ctx.getImageData(Math.max(0,cx-patchSz), Math.max(0,cy-patchSz), Math.min(w,patchSz*2), Math.min(h,patchSz*2)).data;
        let patchGreen=0, patchTotal=0;
        for (let i=0;i<patch.length;i+=4) {
          const r=patch[i], g=patch[i+1], b=patch[i+2];
          if (g > r + 10 && g > b + 10 && g > 50) patchGreen++;
          patchTotal++;
        }
        const patchGreenRatio = patchGreen / Math.max(1, patchTotal);

        // Decide if image is plant-dominant or soil-dominant
        // Heuristic: many green pixels OR center patch green => plant; else soil
        const isPlant = (greenRatio > 0.03) || (patchGreenRatio > 0.2);

        // Evaluate plant health if plant present
        let pestDiseaseLikelihood = 'Low';
        let pestAdvice = 'Looks okay from the photo — continue monitoring.';
        if (isPlant) {
          if (brownRatio > 0.02) {
            pestDiseaseLikelihood = brownRatio > 0.08 ? 'High' : 'Moderate';
            pestAdvice = 'Visible brown/damaged spots detected. Could be pests, fungal infection, or sunburn. Inspect leaves and undersides; remove affected parts and consider local agro-advice.';
          } else if (greenRatio < 0.06) {
            pestDiseaseLikelihood = 'Moderate';
            pestAdvice = 'Plant has reduced green coverage — possible nutrient deficiency or stress. Check watering and fertilizer history.';
          }
        }

        // Soil health heuristic if soil-dominant
        let soilAssessment = 'N/A';
        let soilAdvice = '';
        if (!isPlant) {
          // Brightness and color to guess moisture/organic content
          const avgBrightness = (avgR + avgG + avgB) / 3;
          // color balance: more red/brown => sandy/low organic; darker => more organic/moist
          if (avgBrightness < 70) {
            soilAssessment = 'Dark (likely moist / higher organic matter)';
            soilAdvice = 'Soil looks dark — likely retains moisture or has organic matter. Great for crops but check drainage.';
          } else if (avgR > avgG && Math.abs(avgR - avgG) > 10) {
            soilAssessment = 'Reddish/brown (possible sandy/low organic matter)';
            soilAdvice = 'Soil looks lighter and brown — may be low in organic matter and drain quickly. Add compost or mulch to improve fertility/retention.';
          } else {
            soilAssessment = 'Light/loamy (moderate)';
            soilAdvice = 'Soil looks moderate. Consider simple soil test for nutrients (pH, NPK) for best recommendations.';
          }
        }

        // Compose user-friendly result
        let html = `<h3 style="margin-top:0">Analysis Summary</h3>`;
        html += `<p><strong>Image interpretation:</strong> ${isPlant ? 'Plant/Leaf focused' : 'Soil/ground focused'}</p>`;
        html += `<p><strong>Avg RGB (approx):</strong> R ${Math.round(avgR)}, G ${Math.round(avgG)}, B ${Math.round(avgB)}</p>`;

        if (isPlant) {
          html += `<p><strong>Green presence:</strong> ${(greenRatio*100).toFixed(2)}% (sampled)</p>`;
          html += `<p><strong>Visible spot ratio:</strong> ${(brownRatio*100).toFixed(3)}% (sampled)</p>`;
          html += `<p><strong>Pest/Disease likelihood:</strong> ${pestDiseaseLikelihood}</p>`;
          html += `<p><strong>Recommendation:</strong> ${pestAdvice}</p>`;
        } else {
          html += `<p><strong>Soil assessment:</strong> ${soilAssessment}</p>`;
          html += `<p><strong>Recommendation:</strong> ${soilAdvice || 'Consider a soil lab test for nutrients and pH.'}</p>`;
        }

        // Add safety/help note
        html += `<hr/><p class="small"><strong>Note:</strong> This is a quick image-based heuristic. For accurate diagnosis (pests/diseases/nutrients), combine with local expert consultation or lab tests. To improve accuracy, collect and label many photos to train a model.</p>`;

        resultDiv.innerHTML = html;
      } catch (err) {
        console.error('Analysis failed', err);
        resultDiv.innerHTML = `<p style="color:red">Analysis error — try a different photo. (${err.message || 'unknown'})</p>`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    analyzeBtn.addEventListener('click', analyzeImage);

    // Initialize
    reset();
  })();
  </script>
</body>
</html>