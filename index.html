<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Finance — Secure Demo</title>
<style>
  :root{--bg:#f3f7f8;--card:#fff;--accent:#0b6e4f;--muted:#6b7280}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;color:#07101a}
  .wrap{max-width:1100px;margin:28px auto;padding:18px}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-bottom:14px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .flex{display:flex;gap:8px;align-items:center}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eef4;background:#fcffff}
  button{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  button.ghost{background:transparent;color:var(--muted);border:1px solid #e6eef4}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #eef4f7;text-align:left}
  th{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  .tag{background:#ecfdf5;color:#065f46;padding:6px 8px;border-radius:999px;font-weight:700}
  .center{text-align:center}
  .hidden{display:none}
  .notice{background:#f1f5f9;padding:10px;border-radius:8px;color:#0f172a}
  .receipt-link{color:#0b6e4f;text-decoration:underline;cursor:pointer;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="authCard">
    <header>
      <div>
        <h1>Team Finance — Demo (Shared)</h1>
        <div class="muted">Sign in below. Admin password: <strong>biznezweb2025</strong></div>
      </div>
      <div id="authStatus" class="small"></div>
    </header>

    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
      <div style="min-width:220px">
        <label class="small">Your name</label><br />
        <input id="nameInput" placeholder="e.g. Lamin" />
      </div>

      <div style="min-width:200px">
        <label class="small">Role</label><br />
        <select id="roleSelect">
          <option value="member">Member</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div style="min-width:220px" id="adminPwdWrap" class="hidden">
        <label class="small">Admin password</label><br />
        <input id="adminPwd" type="password" placeholder="Enter admin password" />
      </div>

      <div style="align-self:end">
        <button id="signBtn">Sign in</button>
        <button id="signOutBtn" class="ghost">Sign out</button>
      </div>
    </div>
    <div id="authNote" class="small muted" style="margin-top:8px">Members can add/view transactions. Admins can delete transactions and export CSV.</div>
  </div>

  <div class="card hidden" id="appCard">
    <header>
      <div>
        <h1>Team Finance Dashboard</h1>
        <div class="small muted">Signed in as: <span id="userNameDisp"></span> <span id="roleTag"></span></div>
      </div>
      <div class="flex">
        <button id="exportCsvBtn" class="ghost">Export CSV</button>
        <button id="refreshBtn" class="ghost">Refresh</button>
      </div>
    </header>

    <section style="margin-top:12px" class="grid">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="min-width:200px">
          <label class="small">Amount (GMD)</label><br />
          <input id="amount" type="number" step="0.01" placeholder="e.g. 1200" />
        </div>
        <div style="min-width:160px">
          <label class="small">Type</label><br />
          <select id="type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div style="min-width:220px;flex:1">
          <label class="small">Description</label><br />
          <input id="description" placeholder="e.g. sold produce" />
        </div>
        <div style="min-width:200px">
          <label class="small">Receipt (jpg/png/pdf, max 5MB)</label><br />
          <input id="receipt" type="file" accept="image/*,.pdf" />
        </div>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="addTxBtn">Add transaction</button>
        <button id="clearBtn" class="ghost">Clear</button>
        <div id="uploadProgressWrap" class="small hidden" style="margin-left:12px">
          Uploading: <span id="uploadPct">0</span>%
        </div>
      </div>
    </section>

    <section style="margin-top:16px">
      <div style="margin-top:12px;overflow:auto">
        <table id="txTable">
          <thead><tr><th>Date</th><th>User</th><th>Type</th><th>Amount</th><th>Description</th><th>Receipt</th><th>Action</th></tr></thead>
          <tbody id="txBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="card notice" id="helpCard">
    <strong>How this demo works</strong>
    <ul>
      <li>This demo uses a public Firebase demo project so all members see transactions.</li>
      <li>Admins (use password <strong>biznezweb2025</strong>) can delete transactions and export CSV.</li>
      <li>For production, replace the Firebase config with your own project and enable Authentication & security rules.</li>
      <li>File uploads are limited to 5MB. After upload, you can click on the receipt link to download.</li>
    </ul>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAKsIl5UdCMghM9OgaTw14iCBuFSNilYk4",
  authDomain: "todos-d70a6.firebaseapp.com",
  projectId: "todos-d70a6",
  storageBucket: "todos-d70a6.appspot.com",
  messagingSenderId: "811053328343",
  appId: "1:811053328343:web:c74accaddf3e1bdd9f4d92"
};

const app = initializeApp(FIREBASE_CONFIG);
const db = getFirestore(app);
const storage = getStorage(app);

const authCard = document.getElementById('authCard');
const appCard = document.getElementById('appCard');
const nameInput = document.getElementById('nameInput');
const roleSelect = document.getElementById('roleSelect');
const adminPwdWrap = document.getElementById('adminPwdWrap');
const adminPwd = document.getElementById('adminPwd');
const signBtn = document.getElementById('signBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userNameDisp = document.getElementById('userNameDisp');
const roleTag = document.getElementById('roleTag');

const amountInput = document.getElementById('amount');
const typeInput = document.getElementById('type');
const descInput = document.getElementById('description');
const receiptInput = document.getElementById('receipt');
const addTxBtn = document.getElementById('addTxBtn');
const clearBtn = document.getElementById('clearBtn');
const uploadProgressWrap = document.getElementById('uploadProgressWrap');
const uploadPct = document.getElementById('uploadPct');

const txBody = document.getElementById('txBody');

let currentUser = { name:null, role:'member', isAdmin:false };
const ADMIN_PASSWORD = 'biznezweb2025';
const MAX_FILE_SIZE = 5*1024*1024;

// Role selection
roleSelect.addEventListener('change', ()=>{adminPwdWrap.classList.toggle('hidden', roleSelect.value!=='admin');});

// Sign in
signBtn.addEventListener('click', ()=>{
  const name = nameInput.value.trim();
  const role = roleSelect.value;
  if(!name) return alert('Enter your name');
  if(role==='admin' && adminPwd.value!==ADMIN_PASSWORD) return alert('Wrong admin password');
  currentUser={name,role,isAdmin:role==='admin'};
  localStorage.setItem('team_user', JSON.stringify(currentUser));
  enterApp();
});

// Sign out
signOutBtn.addEventListener('click', ()=>{localStorage.removeItem('team_user'); location.reload();});

// Enter app
function enterApp(){
  authCard.classList.add('hidden');
  appCard.classList.remove('hidden');
  userNameDisp.textContent=currentUser.name;
  roleTag.innerHTML=currentUser.isAdmin?'<span class="tag">ADMIN</span>':'<span class="small muted">Member</span>';
  startRealtime();
}

// Load stored user
const stored=localStorage.getItem('team_user');
if(stored){currentUser=JSON.parse(stored); enterApp();}

const txCol = collection(db,'transactions');
const q = query(txCol, orderBy('date','desc'));
let allTx=[];

function startRealtime(){
  onSnapshot(q, snap=>{
    const docs=[];
    snap.forEach(d=>docs.push({id:d.id,...d.data()}));
    allTx=docs;
    renderTransactions();
  }, err=>{console.error(err); alert(err.message);});
}

function renderTransactions(){
  txBody.innerHTML='';
  let income=0, expense=0;
  for(const tx of allTx){
    if(tx.type==='income') income+=Number(tx.amount||0); else expense+=Number(tx.amount||0);
    const tr=document.createElement('tr');
    const dateText=tx.date?.seconds?new Date(tx.date.seconds*1000).toLocaleString():'—';
    tr.innerHTML=`
      <td>${dateText}</td>
      <td>${tx.userName||'Anonymous'}</td>
      <td>${tx.type}</td>
      <td>GMD ${Number(tx.amount||0).toFixed(2)}</td>
      <td>${tx.description||'—'}</td>
      <td>${tx.receiptUrl?'<a class="receipt-link" href="'+tx.receiptUrl+'" target="_blank">Download</a>':'—'}</td>
      <td></td>
    `;
    const actionTd = tr.querySelector('td:last-child');
    if(currentUser.isAdmin){
      const del = document.createElement('button');
      del.textContent='Delete'; del.className='ghost'; del.style.padding='6px 8px';
      del.addEventListener('click',()=>deleteTx(tx));
      actionTd.appendChild(del);
    }else{actionTd.textContent=currentUser.name===tx.userName?'You':'';}
    txBody.appendChild(tr);
  }
}

// Add transaction
addTxBtn.addEventListener('click', async ()=>{
  const amt=parseFloat(amountInput.value);
  if(!amt || isNaN(amt)) return alert('Enter valid amount');
  if(!currentUser.name) return alert('No user found');
  const file = receiptInput.files?.[0];
  if(file && file.size>MAX_FILE_SIZE) return alert('File too large. Max 5MB.');

  const tx={
    amount: amt,
    type: typeInput.value,
    description: descInput.value||'',
    userId: currentUser.name+'::'+Math.floor(Math.abs(hashCode(currentUser.name))%100000),
    userName: currentUser.name,
    date: serverTimestamp()
  };

  try{
    if(file) tx.receiptUrl = await uploadFile(file);
    await addDoc(txCol, tx);
    amountInput.value=''; descInput.value=''; receiptInput.value='';
    alert('Transaction added!');
  }catch(err){console.error(err); alert(err.message);}
});

function hashCode(str){let h=0; for(let i=0;i<str.length;i++) h=Math.imul(31,h)+str.charCodeAt(i)|0; return h;}

function uploadFile(file){
  return new Promise((resolve,reject)=>{
    const path='receipts/'+Date.now()+'_'+file.name.replace(/\s+/g,'_');
    const storageRef=sref(storage,path);
    const uploadTask=uploadBytesResumable(storageRef,file);
    uploadProgressWrap.classList.remove('hidden');
    uploadPct.textContent='0';
    uploadTask.on('state_changed',
      snapshot=>{
        const pct=Math.floor(snapshot.bytesTransferred/snapshot.totalBytes*100);
        uploadPct.textContent=pct;
      },
      err=>{
        uploadProgressWrap.classList.add('hidden'); reject(err);
      },
      async ()=>{
        try{
          const url=await getDownloadURL(uploadTask.snapshot.ref);
          uploadProgressWrap.classList.add('hidden');
          resolve(url);
        }catch(e){uploadProgressWrap.classList.add('hidden'); reject(e);}
      }
    );
  });
}

// Delete
async function deleteTx(tx){if(!confirm('Delete transaction?')) return; try{await deleteDoc(doc(db,'transactions',tx.id)); alert('Deleted');}catch(e){alert(e.message);}}

// Clear
clearBtn.addEventListener('click', ()=>{amountInput.value=''; typeInput.value='expense'; descInput.value=''; receiptInput.value=''; uploadProgressWrap.classList.add('hidden');});

</script>
</body>
</html>
