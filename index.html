<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Team Finance Demo — Upload & Download</title>
<style>
body{font-family:sans-serif;background:#f3f7f8;margin:0;padding:20px;color:#07101a}
.card{background:#fff;padding:20px;margin:10px auto;border-radius:10px;max-width:1000px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
input,select,button{padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc}
button{background:#0b6e4f;color:#fff;border:none;cursor:pointer}
button.ghost{background:transparent;color:#0b6e4f;border:1px solid #0b6e4f}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.receipt-link{color:#0b6e4f;text-decoration:underline;cursor:pointer;font-size:13px}
.hidden{display:none}
</style>
</head>
<body>

<div class="card" id="authCard">
<h2>Sign In</h2>
<label>Your name</label><br>
<input id="nameInput" placeholder="Your name"><br>
<label>Role</label><br>
<select id="roleSelect">
<option value="member">Member</option>
<option value="admin">Admin</option>
</select><br>
<div id="adminPwdWrap" class="hidden">
<label>Admin password</label><br>
<input id="adminPwd" type="password" placeholder="Admin password">
</div>
<button id="signBtn">Sign In</button>
</div>

<div class="card hidden" id="appCard">
<h2>Finance Dashboard</h2>
<div>Signed in as: <span id="userNameDisp"></span> <span id="roleTag"></span></div>

<h3>Add Transaction</h3>
<label>Amount</label><br>
<input id="amount" type="number" step="0.01"><br>
<label>Type</label><br>
<select id="type"><option value="expense">Expense</option><option value="income">Income</option></select><br>
<label>Description</label><br>
<input id="description"><br>
<label>Receipt (max 5MB)</label><br>
<input type="file" id="receipt" accept="image/*,.pdf"><br>
<button id="addTxBtn">Add Transaction</button>
<button id="clearBtn" class="ghost">Clear</button>
<div id="uploadProgressWrap" class="hidden">Uploading: <span id="uploadPct">0</span>%</div>

<h3>Transactions</h3>
<table>
<thead>
<tr><th>Date</th><th>User</th><th>Type</th><th>Amount</th><th>Description</th><th>Receipt</th></tr>
</thead>
<tbody id="txBody"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref as sref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

// Firebase config
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAKsIl5UdCMghM9OgaTw14iCBuFSNilYk4",
  authDomain: "todos-d70a6.firebaseapp.com",
  projectId: "todos-d70a6",
  storageBucket: "todos-d70a6.appspot.com",
  messagingSenderId: "811053328343",
  appId: "1:811053328343:web:c74accaddf3e1bdd9f4d92"
};

const app = initializeApp(FIREBASE_CONFIG);
const db = getFirestore(app);
const storage = getStorage(app);

const authCard = document.getElementById('authCard');
const appCard = document.getElementById('appCard');
const nameInput = document.getElementById('nameInput');
const roleSelect = document.getElementById('roleSelect');
const adminPwdWrap = document.getElementById('adminPwdWrap');
const adminPwd = document.getElementById('adminPwd');
const signBtn = document.getElementById('signBtn');
const userNameDisp = document.getElementById('userNameDisp');
const roleTag = document.getElementById('roleTag');

const amountInput = document.getElementById('amount');
const typeInput = document.getElementById('type');
const descInput = document.getElementById('description');
const receiptInput = document.getElementById('receipt');
const addTxBtn = document.getElementById('addTxBtn');
const clearBtn = document.getElementById('clearBtn');
const uploadProgressWrap = document.getElementById('uploadProgressWrap');
const uploadPct = document.getElementById('uploadPct');
const txBody = document.getElementById('txBody');

let currentUser = {name:null,role:'member',isAdmin:false};
const ADMIN_PASSWORD = 'biznezweb2025';
const MAX_FILE_SIZE = 5*1024*1024;

roleSelect.addEventListener('change',()=>{adminPwdWrap.classList.toggle('hidden', roleSelect.value!=='admin');});

signBtn.addEventListener('click',()=>{
  const name=nameInput.value.trim();
  const role=roleSelect.value;
  if(!name){alert('Enter name'); return;}
  if(role==='admin' && adminPwd.value!==ADMIN_PASSWORD){alert('Wrong password'); return;}
  currentUser={name,role,isAdmin:role==='admin'};
  localStorage.setItem('team_user',JSON.stringify(currentUser));
  enterApp();
});

function enterApp(){
  authCard.classList.add('hidden');
  appCard.classList.remove('hidden');
  userNameDisp.textContent=currentUser.name;
  roleTag.textContent=currentUser.isAdmin?'ADMIN':'Member';
  startRealtime();
}

const stored = localStorage.getItem('team_user');
if(stored){currentUser=JSON.parse(stored); enterApp();}

// Firestore
const txCol = collection(db,'transactions');
const q = query(txCol, orderBy('date','desc'));
let allTx = [];

function startRealtime(){
  onSnapshot(q, snap=>{
    allTx = [];
    snap.forEach(d=>allTx.push({...d.data()}));
    renderTransactions();
  });
}

function renderTransactions(){
  txBody.innerHTML='';
  allTx.forEach(tx=>{
    const tr=document.createElement('tr');
    const dateText = tx.date?.seconds ? new Date(tx.date.seconds*1000).toLocaleString() : '—';
    const receiptLink = tx.receiptUrl ? `<a class="receipt-link" href="${tx.receiptUrl}" target="_blank">Download</a>` : '—';
    tr.innerHTML=`<td>${dateText}</td><td>${tx.userName||'Anon'}</td><td>${tx.type}</td><td>${Number(tx.amount).toFixed(2)}</td><td>${tx.description||''}</td><td>${receiptLink}</td>`;
    txBody.appendChild(tr);
  });
}

addTxBtn.addEventListener('click', async ()=>{
  const amt = parseFloat(amountInput.value);
  if(!amt){alert('Enter valid amount'); return;}
  const file = receiptInput.files[0];
  if(file && file.size>MAX_FILE_SIZE){alert('File too large'); return;}
  let receiptUrl = null;

  if(file){
    const path = 'receipts/'+Date.now()+'_'+file.name.replace(/\s/g,'_');
    const storageRef = sref(storage,path);
    const uploadTask = uploadBytesResumable(storageRef,file);

    uploadProgressWrap.classList.remove('hidden');
    uploadPct.textContent='0';

    await new Promise((resolve,reject)=>{
      uploadTask.on('state_changed',
        snapshot=>{uploadPct.textContent=Math.floor(snapshot.bytesTransferred/snapshot.totalBytes*100);},
        err=>{uploadProgressWrap.classList.add('hidden'); reject(err);},
        async ()=>{receiptUrl = await getDownloadURL(uploadTask.snapshot.ref); uploadProgressWrap.classList.add('hidden'); resolve();}
      );
    });
  }

  const tx = {
    amount: amt,
    type: typeInput.value,
    description: descInput.value||'',
    userName: currentUser.name,
    date: serverTimestamp(),
    receiptUrl
  };
  await addDoc(txCol,tx);
  amountInput.value=''; descInput.value=''; receiptInput.value='';
});

clearBtn.addEventListener('click',()=>{
  amountInput.value=''; typeInput.value='expense'; descInput.value=''; receiptInput.value=''; uploadProgressWrap.classList.add('hidden');
});
</script>
</body>
</html>
