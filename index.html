<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Team Finance Demo</title>
<style>
body{font-family:sans-serif;background:#f3f7f8;margin:0;padding:20px;color:#07101a}
.card{background:#fff;padding:20px;margin:10px auto;border-radius:10px;max-width:1000px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
input,select,button{padding:8px;margin:4px 0;border-radius:6px;border:1px solid #ccc}
button{background:#0b6e4f;color:#fff;border:none;cursor:pointer}
button.ghost{background:transparent;color:#0b6e4f;border:1px solid #0b6e4f}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
.receipt-link{color:#0b6e4f;text-decoration:underline;cursor:pointer;font-size:13px}
.hidden{display:none}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.totals div{padding:10px;border-radius:6px;background:#f0f0f0;min-width:120px;text-align:center}
.progress-bar{width:100%;height:20px;background:#f0f0f0;border-radius:10px;overflow:hidden;margin-top:10px}
.progress-fill{height:100%;background:#0b6e4f;transition:width 0.3s}
</style>
</head>
<body>

<!--
  FIREBASE SECURITY RULES (Copy-Paste into Firebase Console)
  
  Firestore Rules (Go to Firestore Database > Rules):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /transactions/{transactionId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
                     && request.resource.data.amount is number
                     && request.resource.data.amount > 0
                     && request.resource.data.type in ['income', 'expense']
                     && request.resource.data.userName is string
                     && request.resource.data.description is string
                     && (request.resource.data.receiptUrl == null || request.resource.data.receiptUrl is string);
        allow update: if request.auth != null
                      && resource.data.amount is number
                      && resource.data.amount > 0
                      && resource.data.type in ['income', 'expense']
                      && resource.data.userName is string
                      && resource.data.description is string
                      && (resource.data.receiptUrl == null || resource.data.receiptUrl is string)
                      && (resource.data.userName == request.auth.uid || true);
        allow delete: if request.auth != null;
      }
    }
  }
  
  Storage Rules (Go to Storage > Rules):
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      match /receipts/{allPaths=**} {
        allow read: if request.auth != null;
        allow list: if request.auth != null;
        allow write: if request.auth != null
                     && request.resource.size < 5 * 1024 * 1024
                     && (request.resource.contentType.matches('image/.*') ||
                         request.resource.contentType == 'application/pdf');
      }
      match /{allPaths=**} {
        allow read, write: if false;
      }
    }
  }
-->

<div class="card" id="authCard">
<h2>Sign In</h2>
<label>Your name</label><br>
<input id="nameInput" placeholder="Your name"><br>
<label>Role</label><br>
<select id="roleSelect">
<option value="member">Member</option>
<option value="admin">Admin</option>
</select><br>
<div id="adminPwdWrap" class="hidden">
<label>Admin password</label><br>
<input id="adminPwd" type="password" placeholder="Admin password">
</div>
<button id="signBtn">Sign In</button>
</div>

<div class="card hidden" id="appCard">
<h2>Finance Dashboard</h2>
<div>Signed in as: <span id="userNameDisp"></span> <span id="roleTag"></span></div>

<h3>Add Transaction</h3>
<div class="flex">
<div>
<label>Amount</label><br>
<input id="amount" type="number" step="0.01">
</div>
<div>
<label>Type</label><br>
<select id="type"><option value="expense">Expense</option><option value="income">Income</option></select>
</div>
<div style="flex:1">
<label>Description</label><br>
<input id="description" style="width:100%">
</div>
<div>
<label>Receipt (max 5MB)</label><br>
<input type="file" id="receipt" accept="image/*,.pdf">
</div>
<div>
<button id="addTxBtn">Add</button>
<button id="clearBtn" class="ghost">Clear</button>
</div>
</div>
<div id="uploadProgressWrap" class="hidden">
  Uploading: <span id="uploadPct">0</span>%
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
  </div>
</div>

<h3>Totals</h3>
<div class="flex totals">
<div>Income: <span id="totalIncome">0.00</span></div>
<div>Expense: <span id="totalExpense">0.00</span></div>
<div>Balance: <span id="balance">0.00</span></div>
</div>

<h3>Transactions</h3>
<div class="flex" style="margin-top:8px;gap:10px;flex-wrap:wrap">
<button id="exportCsvBtn" class="ghost">Export CSV</button>
</div>
<table>
<thead>
<tr><th>Date</th><th>User</th><th>Type</th><th>Amount</th><th>Description</th><th>Receipt</th><th>Action</th></tr>
</thead>
<tbody id="txBody"></tbody>
</table>
</div>

<script>
// Firebase config
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAKsIl5UdCMghM9OgaTw14iCBuFSNilYk4",
  authDomain: "todos-d70a6.firebaseapp.com",
  projectId: "todos-d70a6",
  storageBucket: "todos-d70a6.appspot.com",
  messagingSenderId: "811053328343",
  appId: "1:811053328343:web:c74accaddf3e1bdd9f4d92"
};

// UI Elements
const authCard = document.getElementById('authCard');
const appCard = document.getElementById('appCard');
const nameInput = document.getElementById('nameInput');
const roleSelect = document.getElementById('roleSelect');
const adminPwdWrap = document.getElementById('adminPwdWrap');
const adminPwd = document.getElementById('adminPwd');
const signBtn = document.getElementById('signBtn');
const userNameDisp = document.getElementById('userNameDisp');
const roleTag = document.getElementById('roleTag');
const amountInput = document.getElementById('amount');
const typeInput = document.getElementById('type');
const descInput = document.getElementById('description');
const receiptInput = document.getElementById('receipt');
const addTxBtn = document.getElementById('addTxBtn');
const clearBtn = document.getElementById('clearBtn');
const uploadProgressWrap = document.getElementById('uploadProgressWrap');
const uploadPct = document.getElementById('uploadPct');
const progressFill = document.getElementById('progressFill');
const txBody = document.getElementById('txBody');
const totalIncomeEl = document.getElementById('totalIncome');
const totalExpenseEl = document.getElementById('totalExpense');
const balanceEl = document.getElementById('balance');
const exportCsvBtn = document.getElementById('exportCsvBtn');

// App state
let currentUser = {name:null,role:'member',isAdmin:false};
const ADMIN_PASSWORD = 'biznezweb2025';
const MAX_FILE_SIZE = 5*1024*1024;
let allTx = [];

// Initialize Firebase
let app, db, storage, auth;
try {
  app = firebase.initializeApp(FIREBASE_CONFIG);
  db = firebase.firestore();
  storage = firebase.storage();
  auth = firebase.auth();
} catch (error) {
  console.error("Firebase initialization error:", error);
}

// Event listeners
roleSelect.addEventListener('change',()=>{
  adminPwdWrap.classList.toggle('hidden', roleSelect.value!=='admin');
});

signBtn.addEventListener('click',async ()=>{
  const name=nameInput.value.trim();
  const role=roleSelect.value;
  if(!name){alert('Enter name'); return;}
  if(role==='admin' && adminPwd.value!==ADMIN_PASSWORD){alert('Wrong password'); return;}
  currentUser={name,role,isAdmin:role==='admin'};
  localStorage.setItem('team_user',JSON.stringify(currentUser));
  
  try {
    await auth.signInAnonymously();
    enterApp();
  } catch (error) {
    console.error("Anonymous sign-in failed:", error);
    alert('Sign-in failed: ' + error.message);
  }
});

addTxBtn.addEventListener('click',async ()=>{
  const amt=parseFloat(amountInput.value);
  if(!amt || amt <= 0){alert('Enter valid amount'); return;}
  
  const file = receiptInput.files[0];
  if(file && file.size>MAX_FILE_SIZE){alert('File too large (max 5MB)'); return;}
  
  let receiptUrl = null;

  if(file){
    try {
      receiptUrl = await uploadFile(file);
    } catch (error) {
      alert('File upload failed: ' + error.message);
      return;
    }
  }

  try {
    const tx = {
      amount: amt,
      type: typeInput.value,
      description: descInput.value||'',
      userName: currentUser.name,
      date: firebase.firestore.FieldValue.serverTimestamp(),
      receiptUrl
    };
    
    await db.collection('transactions').add(tx);
    amountInput.value=''; 
    descInput.value=''; 
    receiptInput.value='';
  } catch (error) {
    alert('Failed to add transaction: ' + error.message);
  }
});

clearBtn.addEventListener('click',()=>{
  amountInput.value=''; 
  typeInput.value='expense'; 
  descInput.value=''; 
  receiptInput.value=''; 
  uploadProgressWrap.classList.add('hidden');
});

exportCsvBtn.addEventListener('click',()=>{
  if(!currentUser.isAdmin){alert('Admins only'); return;}
  if(!allTx.length){alert('No data'); return;}
  
  const rows=[['Date','User','Type','Amount','Description','Receipt']];
  allTx.forEach(t=>{
    const date = t.date?.seconds ? new Date(t.date.seconds*1000).toISOString() : '';
    rows.push([date,t.userName,t.type,Number(t.amount).toFixed(2),t.description?.replace(/,/g,' '),t.receiptUrl||'']);
  });
  
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); 
  a.href=url; 
  a.download='transactions.csv'; 
  a.click(); 
  URL.revokeObjectURL(url);
});

// Functions
async function enterApp(){
  authCard.classList.add('hidden');
  appCard.classList.remove('hidden');
  userNameDisp.textContent=currentUser.name;
  roleTag.textContent=currentUser.isAdmin?'ADMIN':'Member';
  startRealtime();
}

function startRealtime(){
  db.collection('transactions').orderBy('date','desc').onSnapshot(snap=>{
    allTx = [];
    snap.forEach(d=>allTx.push({...d.data(),id:d.id}));
    renderTransactions();
  }, error => {
    console.error("Firestore error:", error);
  });
}

function renderTransactions(){
  txBody.innerHTML='';
  let income=0,expense=0;
  
  allTx.forEach(tx=>{
    if(tx.type==='income') income+=Number(tx.amount); 
    else expense+=Number(tx.amount);
    
    const tr=document.createElement('tr');
    const dateText = tx.date?.seconds ? new Date(tx.date.seconds*1000).toLocaleString() : '—';
    const receiptLink = tx.receiptUrl ? 
      `<a class="receipt-link" href="${tx.receiptUrl}" target="_blank" download>Download</a>` : '—';
    
    const actionCell = currentUser.isAdmin ? 
      `<button class="ghost" data-id="${tx.id}">Delete</button>` : '';
    
    tr.innerHTML=`
      <td>${dateText}</td>
      <td>${tx.userName}</td>
      <td>${tx.type}</td>
      <td>${Number(tx.amount).toFixed(2)}</td>
      <td>${tx.description}</td>
      <td>${receiptLink}</td>
      <td>${actionCell}</td>
    `;
    txBody.appendChild(tr);
  });
  
  totalIncomeEl.textContent=income.toFixed(2);
  totalExpenseEl.textContent=expense.toFixed(2);
  balanceEl.textContent=(income-expense).toFixed(2);

  // Add delete listeners for admin
  if(currentUser.isAdmin){
    txBody.querySelectorAll('button.ghost').forEach(btn=>{
      btn.addEventListener('click',async ()=>{
        if(confirm('Delete transaction?')){
          try {
            await db.collection('transactions').doc(btn.dataset.id).delete();
          } catch (error) {
            alert('Failed to delete transaction: ' + error.message);
          }
        }
      });
    });
  }
}

async function uploadFile(file) {
  return new Promise((resolve, reject) => {
    const path = 'receipts/' + Date.now() + '_' + file.name.replace(/\s/g, '_');
    const storageRef = storage.ref(path);
    const uploadTask = storageRef.put(file);
    
    uploadProgressWrap.classList.remove('hidden');
    uploadPct.textContent = '0';
    progressFill.style.width = '0%';
    
    uploadTask.on('state_changed',
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        uploadPct.textContent = Math.floor(progress);
        progressFill.style.width = progress + '%';
      },
      (error) => {
        uploadProgressWrap.classList.add('hidden');
        reject(error);
      },
      async () => {
        try {
          const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
          uploadProgressWrap.classList.add('hidden');
          resolve(downloadURL);
        } catch (error) {
          uploadProgressWrap.classList.add('hidden');
          reject(error);
        }
      }
    );
  });
}

// Initialize app
async function initApp() {
  const stored = localStorage.getItem('team_user');
  if(stored){
    try {
      currentUser=JSON.parse(stored); 
      await auth.signInAnonymously();
      enterApp();
    } catch (error) {
      console.error("Error loading stored user or signing in:", error);
    }
  }
}
initApp();
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</body>
</html>
